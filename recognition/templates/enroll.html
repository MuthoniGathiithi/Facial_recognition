<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enroll Face</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; color: #222; }
    .container { max-width: 640px; margin: 40px auto; background: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);} 
    label { display:block; margin-top:12px; font-size:14px; }
    input[type=text], input[type=file] { width:100%; padding:8px; font-size:14px; }
    button { margin-top:12px; padding:10px 14px; font-size:14px; background:#2b7cff; color:#fff; border:none; border-radius:4px; cursor:pointer }
    .small { font-size:12px; color:#666 }
    .row { display:flex; gap:8px; align-items:center }
    #video { border:1px solid #ddd; width:320px; height:240px; background:#000 }
    .msg-success { color: #27ae60 }
    .msg-error { color: #c0392b }
  </style>
</head>
<body>
  <div class="container">
    <h2>Enroll Face</h2>
    {% if messages %}
      {% for msg in messages %}
        <p class="{% if 'error' in msg.tags %}msg-error{% else %}msg-success{% endif %}"><strong>{{ msg }}</strong></p>
      {% endfor %}
    {% endif %}
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <label for="name">Name</label>
      <input type="text" id="name" name="name" required />

      <label class="small">1) Capture with webcam</label>
      <div class="row">
        <video id="video" autoplay playsinline></video>
        <div>
          <button type="button" id="startBtn">Start Camera</button>
          <button type="button" id="snapBtn">Take Photo</button>
        </div>
      </div>
      <input type="hidden" name="captured_photo" id="captured_photo" />

      <label class="small">2) Upload image (browse)</label>
      <input type="file" name="file1" accept="image/*" />

      <label class="small">3) Upload image (optional)</label>
      <input type="file" name="file2" accept="image/*" />

      <div style="margin-top:14px">
        <p class="small">Captured photo preview:</p>
        <img id="preview" src="" alt="Captured preview" style="width:160px; height:120px; border:1px solid #ddd; display:block; margin-bottom:8px; object-fit:cover" />
        <div style="display:flex; gap:8px;">
          <button type="submit">Enroll</button>
          <!-- Separate small form to post captured base64 directly to matching view -->
          <form id="matchForm" method="post" action="{% url 'match' %}">
            {% csrf_token %}
            <input type="hidden" name="captured_photo" id="match_captured_photo" />
            <button type="submit" id="matchBtn">Match</button>
          </form>
        </div>
      </div>
    </form>

    <!-- Delete-all enrollments removed per user request -->
  </div>

  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const snapBtn = document.getElementById('snapBtn');
    const captured = document.getElementById('captured_photo');
    let stream = null;

    startBtn.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (e) {
        alert('Could not access camera: ' + e.message);
      }
    });

    const preview = document.getElementById('preview');
    snapBtn.addEventListener('click', () => {
      if (!stream) { alert('Start the camera first'); return }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 320;
      canvas.height = video.videoHeight || 240;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const data = canvas.toDataURL('image/png');
      captured.value = data;
      preview.src = data;
  // Also copy captured data into the match form hidden field so the
  // separate Match button can submit it directly to the matching view.
  const matchHidden = document.getElementById('match_captured_photo');
  if (matchHidden) matchHidden.value = data;
      // stop camera to save resources after taking the photo
      try {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      } catch (e) {
        // ignore
      }
    });

    // Keep the match hidden input in sync if the captured value changes
    // (for example if a user re-takes the photo)
    const capturedInput = document.getElementById('captured_photo');
    if (capturedInput) {
      capturedInput.addEventListener('change', () => {
        const matchHidden = document.getElementById('match_captured_photo');
        if (matchHidden) matchHidden.value = capturedInput.value;
      });
    }
  </script>
</body>
</html>
